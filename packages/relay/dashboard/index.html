<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Gun Relay Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4">Gun Relay Dashboard</h1>
        
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">Connessioni Attive</h5>
                        <h2 id="connections">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">Operazioni Put</h5>
                        <h2 id="putOps">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">Operazioni Get</h5>
                        <h2 id="getOps">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <h5 class="card-title">Dati Trasferiti</h5>
                        <h2 id="bytesTransferred">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Statistiche Protocollo</h5>
                        
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <h6>Messaggi</h6>
                                <ul class="list-unstyled">
                                    <li>Inviati: <span id="msgSent">-</span></li>
                                    <li>Ricevuti: <span id="msgReceived">-</span></li>
                                    <li>Crittografati: <span id="msgEncrypted">-</span></li>
                                    <li>Falliti: <span id="msgFailed">-</span></li>
                                </ul>
                            </div>
                            
                            <div class="col-md-3">
                                <h6>Autenticazione</h6>
                                <ul class="list-unstyled">
                                    <li>Login: <span id="authLogins">-</span></li>
                                    <li>Registrazioni: <span id="authRegs">-</span></li>
                                    <li>Errori: <span id="authFails">-</span></li>
                                </ul>
                            </div>
                            
                            <div class="col-md-3">
                                <h6>Amicizie</h6>
                                <ul class="list-unstyled">
                                    <li>Richieste: <span id="friendReqs">-</span></li>
                                    <li>Accettate: <span id="friendAccepts">-</span></li>
                                    <li>Rifiutate: <span id="friendRejects">-</span></li>
                                </ul>
                            </div>
                            
                            <div class="col-md-3">
                                <h6>Canali</h6>
                                <ul class="list-unstyled">
                                    <li>Creati: <span id="channelsCreated">-</span></li>
                                    <li>Messaggi: <span id="channelMsgs">-</span></li>
                                    <li>Membri: <span id="channelMembers">-</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Backup IPFS</h5>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Ultimo Backup</h6>
                                <ul class="list-unstyled">
                                    <li>Hash: <span id="lastBackupHash">-</span></li>
                                    <li>Data: <span id="lastBackupTime">-</span></li>
                                    <li>Dimensione: <span id="lastBackupSize">-</span></li>
                                    <li>Link: <a id="lastBackupLink" href="#" target="_blank">Visualizza su IPFS</a></li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Statistiche Backup</h6>
                                <ul class="list-unstyled">
                                    <li>Totali: <span id="backupsTotal">-</span></li>
                                    <li>Riusciti: <span id="backupsSuccessful">-</span></li>
                                    <li>Falliti: <span id="backupsFailed">-</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Utilizzo CPU</h5>
                        <canvas id="cpuChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Memoria</h5>
                        <canvas id="memoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Spazio Utilizzato</h5>
                    <div class="row mt-3">
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Database (Radata)</h6>
                                <h3 id="radataStorage">-</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Nodi</h6>
                                <h3 id="nodesStorage">-</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Backup</h6>
                                <h3 id="backupsStorage">-</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card">
                                <h6>Totale</h6>
                                <h3 id="totalStorage">-</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cpuChart, memoryChart;
        
        function initCharts() {
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            cpuChart = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Carico CPU %',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Utilizzo CPU (%)'
                            }
                        }
                    },
                    animation: {
                        duration: 0
                    }
                }
            });

            const memCtx = document.getElementById('memoryChart').getContext('2d');
            memoryChart = new Chart(memCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizzata', 'Libera'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#ff6384', '#36a2eb']
                    }]
                }
            });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateDashboard() {
            fetch('/metrics')
            .then(response => response.json())
            .then(metrics => {
                // Debug
                console.log('Metriche ricevute:', metrics);

                // Metriche base
                document.getElementById('connections').textContent = metrics.connections || 0;
                document.getElementById('putOps').textContent = metrics.putOperations || 0;
                document.getElementById('getOps').textContent = metrics.getOperations || 0;
                document.getElementById('bytesTransferred').textContent = formatBytes(metrics.bytesTransferred || 0);

                // Storage
                if (metrics.storage) {
                    document.getElementById('radataStorage').textContent = formatBytes(metrics.storage.radata || 0);
                    document.getElementById('nodesStorage').textContent = formatBytes(metrics.storage.nodes || 0);
                    document.getElementById('backupsStorage').textContent = formatBytes(metrics.storage.backups || 0);
                    document.getElementById('totalStorage').textContent = formatBytes(metrics.storage.total || 0);
                }

                // Grafico CPU
                if (metrics.cpu && metrics.cpu.length > 0) {
                    const timestamp = new Date().toLocaleTimeString();
                    const cpuValue = metrics.cpu[0].toFixed(2); // 2 decimali
                    cpuChart.data.labels.push(timestamp);
                    cpuChart.data.datasets[0].data.push(cpuValue);
                    
                    if (cpuChart.data.labels.length > 30) { // Mostra 30 secondi di dati
                        cpuChart.data.labels.shift();
                        cpuChart.data.datasets[0].data.shift();
                    }
                    cpuChart.update();
                }

                // Grafico memoria
                if (metrics.memory) {
                    const used = metrics.memory.total - metrics.memory.free;
                    const usedGB = (used / (1024 * 1024 * 1024)).toFixed(2);
                    const totalGB = (metrics.memory.total / (1024 * 1024 * 1024)).toFixed(2);
                    
                    memoryChart.data.datasets[0].data = [usedGB, totalGB - usedGB];
                    memoryChart.data.labels = [
                        `Utilizzata (${usedGB} GB)`,
                        `Libera (${(totalGB - usedGB).toFixed(2)} GB)`
                    ];
                    memoryChart.update();
                }

                // Metriche del protocollo
                if (metrics.protocol) {
                    const p = metrics.protocol;
                    // Messaggi
                    document.getElementById('msgSent').textContent = p.messages.sent || 0;
                    document.getElementById('msgReceived').textContent = p.messages.received || 0;
                    document.getElementById('msgEncrypted').textContent = p.messages.encrypted || 0;
                    document.getElementById('msgFailed').textContent = p.messages.failed || 0;
                    
                    // Autenticazione
                    document.getElementById('authLogins').textContent = p.authentication.logins || 0;
                    document.getElementById('authRegs').textContent = p.authentication.registrations || 0;
                    document.getElementById('authFails').textContent = p.authentication.failures || 0;
                    
                    // Amicizie
                    document.getElementById('friendReqs').textContent = p.friends.requests || 0;
                    document.getElementById('friendAccepts').textContent = p.friends.accepted || 0;
                    document.getElementById('friendRejects').textContent = p.friends.rejected || 0;
                    
                    // Canali
                    document.getElementById('channelsCreated').textContent = p.channels.created || 0;
                    document.getElementById('channelMsgs').textContent = p.channels.messages || 0;
                    document.getElementById('channelMembers').textContent = p.channels.members || 0;
                }

                // Backup IPFS
                if (metrics.backups) {
                    const b = metrics.backups;
                    document.getElementById('lastBackupHash').textContent = b.lastBackup.hash || '-';
                    document.getElementById('lastBackupTime').textContent = b.lastBackup.time || '-';
                    document.getElementById('lastBackupSize').textContent = formatBytes(b.lastBackup.size || 0);
                    document.getElementById('lastBackupLink').href = b.lastBackup.link || '#';
                    document.getElementById('backupsTotal').textContent = b.stats.total || 0;
                    document.getElementById('backupsSuccessful').textContent = b.stats.successful || 0;
                    document.getElementById('backupsFailed').textContent = b.stats.failed || 0;
                }
            })
            .catch(error => {
                console.error('Errore aggiornamento dashboard:', error);
            });
        }

        initCharts();
        setInterval(updateDashboard, 500);
    </script>
</body>
</html> 